var ln=Object.defineProperty;var ot=(e,t)=>{for(var n in t)ln(e,n,{get:t[n],enumerable:!0})};var O=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"];function me(e){let t=typeof e=="string"?new TextEncoder().encode(e):e instanceof Uint8Array?e:new Uint8Array(e),n="",r,o=t.length;for(r=2;r<o;r+=3)n+=O[t[r-2]>>2],n+=O[(t[r-2]&3)<<4|t[r-1]>>4],n+=O[(t[r-1]&15)<<2|t[r]>>6],n+=O[t[r]&63];return r===o+1&&(n+=O[t[r-2]>>2],n+=O[(t[r-2]&3)<<4],n+="=="),r===o&&(n+=O[t[r-2]>>2],n+=O[(t[r-2]&3)<<4|t[r-1]>>4],n+=O[(t[r-1]&15)<<2],n+="="),n}function Q(e){let t=atob(e),n=t.length,r=new Uint8Array(n);for(let o=0;o<n;o++)r[o]=t.charCodeAt(o);return r}function st(e){if(!e)return{};try{return JSON.parse(new TextDecoder().decode(Q(e)))}catch{return{}}}function it(e){if(!e)return{};try{return JSON.parse(atob(e))}catch{return{}}}function at(e,t,n){let{primary_region:r,token:o,url:s,url_uncached:i}=e;if(!o||!s||!n.id)return;let a={deployID:t.id,edgeURL:s,primaryRegion:r,siteID:n.id,token:o,uncachedEdgeURL:i};globalThis.netlifyBlobsContext=me(JSON.stringify(a))}function ct(e){if(e===null)return{};try{let t=new TextDecoder().decode(Q(e)),{postal_code:n,...r}=JSON.parse(t);return Object.fromEntries(Object.entries({...r,postalCode:n}).filter(([s,i])=>i!==void 0))}catch{return{}}}var lt=["if-match","if-none-match","if-modified-since","if-unmodified-since","if-range"],$e=(e,t)=>{let n={};return t.forEach((r,o)=>{e.get(o)!==r&&(n[o]=r)}),e.forEach((r,o)=>{t.has(o)||(n[o]="")}),n},We=(e,t)=>{let n=$e(e,t);return Object.keys(n).length!==0},ut=e=>{let t={};return e.forEach((n,r)=>{(r==="set-cookie"?[n]:n.split(", ")).forEach(s=>{t[r]=[...t[r]||[],s]})}),t},xe=(e,t)=>{let n=new Response(e.body,e);return t(n.headers),n};var ft=e=>{let t=e?.cause instanceof Error?ft(e.cause):e.cause;return{error:e.message,error_cause:t,error_stack:e.stack}},Re=class e{fields;filter;logLevel;message;rawLogger;requestID;__netlifyStructuredLogger;constructor(t,n,r,o,s,i){this.filter=i,this.fields=n??{},this.logLevel=s??2,this.message=t??"",this.rawLogger=o,this.requestID=r,this.__netlifyStructuredLogger=1}debug(t){if(this.logLevel>1||this.filter&&!this.filter(t,this.fields))return;(this.rawLogger??globalThis.console.log)(new e(t,this.fields,this.requestID,this.rawLogger,this.logLevel,this.filter))}error(t){if(this.logLevel>3||this.filter&&!this.filter(t,this.fields))return;(this.rawLogger??globalThis.console.log)(new e(t,this.fields,this.requestID,this.rawLogger,this.logLevel,this.filter))}log(t){if(this.logLevel>2||this.filter&&!this.filter(t,this.fields))return;(this.rawLogger??globalThis.console.log)(new e(t,this.fields,this.requestID,this.rawLogger,this.logLevel,this.filter))}serialize(){return{fields:this.fields,message:this.message,requestID:this.requestID}}withError(t){let n=t instanceof Error?ft(t):{error:t};return this.withFields(n)}withFields(t){return new e(this.message,{...this.fields,...t},this.requestID,this.rawLogger,this.logLevel,this.filter)}withFilter(t){if(!t)return this;if(typeof t!="function")throw new TypeError("Filter must be a function");return new e(this.message,this.fields,this.requestID,this.rawLogger,this.logLevel,t)}withLogLevel(t){return new e(this.message,this.fields,this.requestID,this.rawLogger,t,this.filter)}withRawLogger(t){return new e(this.message,this.fields,this.requestID,t,this.logLevel,this.filter)}withRequestID(t){return t===null?this:new e(this.message,this.fields,t,this.rawLogger,this.logLevel,this.filter)}},dt=new Re;var gt=!1,M=()=>Deno.env.get("DENO_DEPLOYMENT_ID")?"production":"local",ht=e=>{if(gt)return;let t=ie(e);t.id&&Deno.env.set("SITE_ID",t.id),t.name&&Deno.env.set("SITE_NAME",t.name),t.url&&Deno.env.set("URL",t.url);let n=pt(e);n&&Deno.env.set("NETLIFY_PURGE_API_TOKEN",n),gt=!0};import{AsyncLocalStorage as Kn}from"node:async_hooks";var mt=(()=>{let{Deno:e}=globalThis;if(typeof e?.build?.os=="string")return e.build.os;let{navigator:t}=globalThis;return t?.appVersion?.includes?.("Win")?"windows":"linux"})(),ae=mt==="windows";var ce={};ot(ce,{basename:()=>Cn,delimiter:()=>xn,dirname:()=>bn,extname:()=>An,format:()=>Tn,fromFileUrl:()=>Sn,isAbsolute:()=>Rt,join:()=>Rn,normalize:()=>xt,parse:()=>En,relative:()=>yn,resolve:()=>Ce,sep:()=>mn,toFileUrl:()=>Ln,toNamespacedPath:()=>wn});function S(e){if(typeof e!="string")throw new TypeError(`Path must be a string. Received ${JSON.stringify(e)}`)}function ye(e){return e===47}function m(e){return ye(e)||e===92}function H(e){return e>=97&&e<=122||e>=65&&e<=90}function Y(e,t,n,r){let o="",s=0,i=-1,a=0,l;for(let d=0,f=e.length;d<=f;++d){if(d<f)l=e.charCodeAt(d);else{if(r(l))break;l=47}if(r(l)){if(!(i===d-1||a===1))if(i!==d-1&&a===2){if(o.length<2||s!==2||o.charCodeAt(o.length-1)!==46||o.charCodeAt(o.length-2)!==46){if(o.length>2){let c=o.lastIndexOf(n);c===-1?(o="",s=0):(o=o.slice(0,c),s=o.length-1-o.lastIndexOf(n)),i=d,a=0;continue}else if(o.length===2||o.length===1){o="",s=0,i=d,a=0;continue}}t&&(o.length>0?o+=`${n}..`:o="..",s=2)}else o.length>0?o+=n+e.slice(i+1,d):o=e.slice(i+1,d),s=d-i-1;i=d,a=0}else l===46&&a!==-1?++a:a=-1}return o}function we(e,t){let n=t.dir||t.root,r=t.base||(t.name||"")+(t.ext||"");return n?n===t.root?n+r:n+e+r:r}var hn={"	":"%09","\n":"%0A","\v":"%0B","\f":"%0C","\r":"%0D"," ":"%20"};function be(e){return e.replaceAll(/[\s]/g,t=>hn[t]??t)}var je=class extends Error{constructor(t){super(t),this.name="DenoStdInternalError"}};function q(e,t=""){if(!e)throw new je(t)}var mn="\\",xn=";";function Ce(...e){let t="",n="",r=!1;for(let o=e.length-1;o>=-1;o--){let s,{Deno:i}=globalThis;if(o>=0)s=e[o];else if(t){if(typeof i?.env?.get!="function"||typeof i?.cwd!="function")throw new TypeError("Resolved a relative path without a CWD.");s=i.cwd(),(s===void 0||s.slice(0,3).toLowerCase()!==`${t.toLowerCase()}\\`)&&(s=`${t}\\`)}else{if(typeof i?.cwd!="function")throw new TypeError("Resolved a drive-letter-less path without a CWD.");s=i.cwd()}S(s);let a=s.length;if(a===0)continue;let l=0,d="",f=!1,c=s.charCodeAt(0);if(a>1)if(m(c))if(f=!0,m(s.charCodeAt(1))){let u=2,C=u;for(;u<a&&!m(s.charCodeAt(u));++u);if(u<a&&u!==C){let R=s.slice(C,u);for(C=u;u<a&&m(s.charCodeAt(u));++u);if(u<a&&u!==C){for(C=u;u<a&&!m(s.charCodeAt(u));++u);u===a?(d=`\\\\${R}\\${s.slice(C)}`,l=u):u!==C&&(d=`\\\\${R}\\${s.slice(C,u)}`,l=u)}}}else l=1;else H(c)&&s.charCodeAt(1)===58&&(d=s.slice(0,2),l=2,a>2&&m(s.charCodeAt(2))&&(f=!0,l=3));else m(c)&&(l=1,f=!0);if(!(d.length>0&&t.length>0&&d.toLowerCase()!==t.toLowerCase())&&(t.length===0&&d.length>0&&(t=d),r||(n=`${s.slice(l)}\\${n}`,r=f),r&&t.length>0))break}return n=Y(n,!r,"\\",m),t+(r?"\\":"")+n||"."}function xt(e){S(e);let t=e.length;if(t===0)return".";let n=0,r,o=!1,s=e.charCodeAt(0);if(t>1)if(m(s))if(o=!0,m(e.charCodeAt(1))){let a=2,l=a;for(;a<t&&!m(e.charCodeAt(a));++a);if(a<t&&a!==l){let d=e.slice(l,a);for(l=a;a<t&&m(e.charCodeAt(a));++a);if(a<t&&a!==l){for(l=a;a<t&&!m(e.charCodeAt(a));++a);if(a===t)return`\\\\${d}\\${e.slice(l)}\\`;a!==l&&(r=`\\\\${d}\\${e.slice(l,a)}`,n=a)}}}else n=1;else H(s)&&e.charCodeAt(1)===58&&(r=e.slice(0,2),n=2,t>2&&m(e.charCodeAt(2))&&(o=!0,n=3));else if(m(s))return"\\";let i;return n<t?i=Y(e.slice(n),!o,"\\",m):i="",i.length===0&&!o&&(i="."),i.length>0&&m(e.charCodeAt(t-1))&&(i+="\\"),r===void 0?o?i.length>0?`\\${i}`:"\\":i.length>0?i:"":o?i.length>0?`${r}\\${i}`:`${r}\\`:i.length>0?r+i:r}function Rt(e){S(e);let t=e.length;if(t===0)return!1;let n=e.charCodeAt(0);return m(n)?!0:!!(H(n)&&t>2&&e.charCodeAt(1)===58&&m(e.charCodeAt(2)))}function Rn(...e){let t=e.length;if(t===0)return".";let n,r=null;for(let i=0;i<t;++i){let a=e[i];S(a),a.length>0&&(n===void 0?n=r=a:n+=`\\${a}`)}if(n===void 0)return".";let o=!0,s=0;if(q(r!=null),m(r.charCodeAt(0))){++s;let i=r.length;i>1&&m(r.charCodeAt(1))&&(++s,i>2&&(m(r.charCodeAt(2))?++s:o=!1))}if(o){for(;s<n.length&&m(n.charCodeAt(s));++s);s>=2&&(n=`\\${n.slice(s)}`)}return xt(n)}function yn(e,t){if(S(e),S(t),e===t)return"";let n=Ce(e),r=Ce(t);if(n===r||(e=n.toLowerCase(),t=r.toLowerCase(),e===t))return"";let o=0,s=e.length;for(;o<s&&e.charCodeAt(o)===92;++o);for(;s-1>o&&e.charCodeAt(s-1)===92;--s);let i=s-o,a=0,l=t.length;for(;a<l&&t.charCodeAt(a)===92;++a);for(;l-1>a&&t.charCodeAt(l-1)===92;--l);let d=l-a,f=i<d?i:d,c=-1,u=0;for(;u<=f;++u){if(u===f){if(d>f){if(t.charCodeAt(a+u)===92)return r.slice(a+u+1);if(u===2)return r.slice(a+u)}i>f&&(e.charCodeAt(o+u)===92?c=u:u===2&&(c=3));break}let R=e.charCodeAt(o+u),w=t.charCodeAt(a+u);if(R!==w)break;R===92&&(c=u)}if(u!==f&&c===-1)return r;let C="";for(c===-1&&(c=0),u=o+c+1;u<=s;++u)(u===s||e.charCodeAt(u)===92)&&(C.length===0?C+="..":C+="\\..");return C.length>0?C+r.slice(a+c,l):(a+=c,r.charCodeAt(a)===92&&++a,r.slice(a,l))}function wn(e){if(typeof e!="string")return e;if(e.length===0)return"";let t=Ce(e);if(t.length>=3){if(t.charCodeAt(0)===92){if(t.charCodeAt(1)===92){let n=t.charCodeAt(2);if(n!==63&&n!==46)return`\\\\?\\UNC\\${t.slice(2)}`}}else if(H(t.charCodeAt(0))&&t.charCodeAt(1)===58&&t.charCodeAt(2)===92)return`\\\\?\\${t}`}return e}function bn(e){S(e);let t=e.length;if(t===0)return".";let n=-1,r=-1,o=!0,s=0,i=e.charCodeAt(0);if(t>1)if(m(i)){if(n=s=1,m(e.charCodeAt(1))){let a=2,l=a;for(;a<t&&!m(e.charCodeAt(a));++a);if(a<t&&a!==l){for(l=a;a<t&&m(e.charCodeAt(a));++a);if(a<t&&a!==l){for(l=a;a<t&&!m(e.charCodeAt(a));++a);if(a===t)return e;a!==l&&(n=s=a+1)}}}}else H(i)&&e.charCodeAt(1)===58&&(n=s=2,t>2&&m(e.charCodeAt(2))&&(n=s=3));else if(m(i))return e;for(let a=t-1;a>=s;--a)if(m(e.charCodeAt(a))){if(!o){r=a;break}}else o=!1;if(r===-1){if(n===-1)return".";r=n}return e.slice(0,r)}function Cn(e,t=""){if(t!==void 0&&typeof t!="string")throw new TypeError('"ext" argument must be a string');S(e);let n=0,r=-1,o=!0,s;if(e.length>=2){let i=e.charCodeAt(0);H(i)&&e.charCodeAt(1)===58&&(n=2)}if(t!==void 0&&t.length>0&&t.length<=e.length){if(t.length===e.length&&t===e)return"";let i=t.length-1,a=-1;for(s=e.length-1;s>=n;--s){let l=e.charCodeAt(s);if(m(l)){if(!o){n=s+1;break}}else a===-1&&(o=!1,a=s+1),i>=0&&(l===t.charCodeAt(i)?--i===-1&&(r=s):(i=-1,r=a))}return n===r?r=a:r===-1&&(r=e.length),e.slice(n,r)}else{for(s=e.length-1;s>=n;--s)if(m(e.charCodeAt(s))){if(!o){n=s+1;break}}else r===-1&&(o=!1,r=s+1);return r===-1?"":e.slice(n,r)}}function An(e){S(e);let t=0,n=-1,r=0,o=-1,s=!0,i=0;e.length>=2&&e.charCodeAt(1)===58&&H(e.charCodeAt(0))&&(t=r=2);for(let a=e.length-1;a>=t;--a){let l=e.charCodeAt(a);if(m(l)){if(!s){r=a+1;break}continue}o===-1&&(s=!1,o=a+1),l===46?n===-1?n=a:i!==1&&(i=1):n!==-1&&(i=-1)}return n===-1||o===-1||i===0||i===1&&n===o-1&&n===r+1?"":e.slice(n,o)}function Tn(e){if(e===null||typeof e!="object")throw new TypeError(`The "pathObject" argument must be of type Object. Received type ${typeof e}`);return we("\\",e)}function En(e){S(e);let t={root:"",dir:"",base:"",ext:"",name:""},n=e.length;if(n===0)return t;let r=0,o=e.charCodeAt(0);if(n>1){if(m(o)){if(r=1,m(e.charCodeAt(1))){let c=2,u=c;for(;c<n&&!m(e.charCodeAt(c));++c);if(c<n&&c!==u){for(u=c;c<n&&m(e.charCodeAt(c));++c);if(c<n&&c!==u){for(u=c;c<n&&!m(e.charCodeAt(c));++c);c===n?r=c:c!==u&&(r=c+1)}}}}else if(H(o)&&e.charCodeAt(1)===58)if(r=2,n>2){if(m(e.charCodeAt(2))){if(n===3)return t.root=t.dir=e,t;r=3}}else return t.root=t.dir=e,t}else if(m(o))return t.root=t.dir=e,t;r>0&&(t.root=e.slice(0,r));let s=-1,i=r,a=-1,l=!0,d=e.length-1,f=0;for(;d>=r;--d){if(o=e.charCodeAt(d),m(o)){if(!l){i=d+1;break}continue}a===-1&&(l=!1,a=d+1),o===46?s===-1?s=d:f!==1&&(f=1):s!==-1&&(f=-1)}return s===-1||a===-1||f===0||f===1&&s===a-1&&s===i+1?a!==-1&&(t.base=t.name=e.slice(i,a)):(t.name=e.slice(i,s),t.base=e.slice(i,a),t.ext=e.slice(s,a)),i>0&&i!==r?t.dir=e.slice(0,i-1):t.dir=t.root,t}function Sn(e){if(e=e instanceof URL?e:new URL(e),e.protocol!="file:")throw new TypeError("Must be a file URL.");let t=decodeURIComponent(e.pathname.replace(/\//g,"\\").replace(/%(?![0-9A-Fa-f]{2})/g,"%25")).replace(/^\\*([A-Za-z]:)(\\|$)/,"$1\\");return e.hostname!=""&&(t=`\\\\${e.hostname}${t}`),t}function Ln(e){if(!Rt(e))throw new TypeError("Must be an absolute path.");let[,t,n]=e.match(/^(?:[/\\]{2}([^/\\]+)(?=[/\\](?:[^/\\]|$)))?(.*)/),r=new URL("file:///");if(r.pathname=be(n.replace(/%/g,"%25")),t!=null&&t!="localhost"&&(r.hostname=t,!r.hostname))throw new TypeError("Invalid hostname.");return r}var le={};ot(le,{basename:()=>qn,delimiter:()=>Pn,dirname:()=>_n,extname:()=>In,format:()=>Nn,fromFileUrl:()=>On,isAbsolute:()=>wt,join:()=>vn,normalize:()=>yt,parse:()=>Un,relative:()=>kn,resolve:()=>Ke,sep:()=>Dn,toFileUrl:()=>Mn,toNamespacedPath:()=>Fn});var Dn="/",Pn=":";function Ke(...e){let t="",n=!1;for(let r=e.length-1;r>=-1&&!n;r--){let o;if(r>=0)o=e[r];else{let{Deno:s}=globalThis;if(typeof s?.cwd!="function")throw new TypeError("Resolved a relative path without a CWD.");o=s.cwd()}S(o),o.length!==0&&(t=`${o}/${t}`,n=o.charCodeAt(0)===47)}return t=Y(t,!n,"/",ye),n?t.length>0?`/${t}`:"/":t.length>0?t:"."}function yt(e){if(S(e),e.length===0)return".";let t=e.charCodeAt(0)===47,n=e.charCodeAt(e.length-1)===47;return e=Y(e,!t,"/",ye),e.length===0&&!t&&(e="."),e.length>0&&n&&(e+="/"),t?`/${e}`:e}function wt(e){return S(e),e.length>0&&e.charCodeAt(0)===47}function vn(...e){if(e.length===0)return".";let t;for(let n=0,r=e.length;n<r;++n){let o=e[n];S(o),o.length>0&&(t?t+=`/${o}`:t=o)}return t?yt(t):"."}function kn(e,t){if(S(e),S(t),e===t||(e=Ke(e),t=Ke(t),e===t))return"";let n=1,r=e.length;for(;n<r&&e.charCodeAt(n)===47;++n);let o=r-n,s=1,i=t.length;for(;s<i&&t.charCodeAt(s)===47;++s);let a=i-s,l=o<a?o:a,d=-1,f=0;for(;f<=l;++f){if(f===l){if(a>l){if(t.charCodeAt(s+f)===47)return t.slice(s+f+1);if(f===0)return t.slice(s+f)}else o>l&&(e.charCodeAt(n+f)===47?d=f:f===0&&(d=0));break}let u=e.charCodeAt(n+f),C=t.charCodeAt(s+f);if(u!==C)break;u===47&&(d=f)}let c="";for(f=n+d+1;f<=r;++f)(f===r||e.charCodeAt(f)===47)&&(c.length===0?c+="..":c+="/..");return c.length>0?c+t.slice(s+d):(s+=d,t.charCodeAt(s)===47&&++s,t.slice(s))}function Fn(e){return e}function _n(e){if(S(e),e.length===0)return".";let t=e.charCodeAt(0)===47,n=-1,r=!0;for(let o=e.length-1;o>=1;--o)if(e.charCodeAt(o)===47){if(!r){n=o;break}}else r=!1;return n===-1?t?"/":".":t&&n===1?"//":e.slice(0,n)}function qn(e,t=""){if(t!==void 0&&typeof t!="string")throw new TypeError('"ext" argument must be a string');S(e);let n=0,r=-1,o=!0,s;if(t!==void 0&&t.length>0&&t.length<=e.length){if(t.length===e.length&&t===e)return"";let i=t.length-1,a=-1;for(s=e.length-1;s>=0;--s){let l=e.charCodeAt(s);if(l===47){if(!o){n=s+1;break}}else a===-1&&(o=!1,a=s+1),i>=0&&(l===t.charCodeAt(i)?--i===-1&&(r=s):(i=-1,r=a))}return n===r?r=a:r===-1&&(r=e.length),e.slice(n,r)}else{for(s=e.length-1;s>=0;--s)if(e.charCodeAt(s)===47){if(!o){n=s+1;break}}else r===-1&&(o=!1,r=s+1);return r===-1?"":e.slice(n,r)}}function In(e){S(e);let t=-1,n=0,r=-1,o=!0,s=0;for(let i=e.length-1;i>=0;--i){let a=e.charCodeAt(i);if(a===47){if(!o){n=i+1;break}continue}r===-1&&(o=!1,r=i+1),a===46?t===-1?t=i:s!==1&&(s=1):t!==-1&&(s=-1)}return t===-1||r===-1||s===0||s===1&&t===r-1&&t===n+1?"":e.slice(t,r)}function Nn(e){if(e===null||typeof e!="object")throw new TypeError(`The "pathObject" argument must be of type Object. Received type ${typeof e}`);return we("/",e)}function Un(e){S(e);let t={root:"",dir:"",base:"",ext:"",name:""};if(e.length===0)return t;let n=e.charCodeAt(0)===47,r;n?(t.root="/",r=1):r=0;let o=-1,s=0,i=-1,a=!0,l=e.length-1,d=0;for(;l>=r;--l){let f=e.charCodeAt(l);if(f===47){if(!a){s=l+1;break}continue}i===-1&&(a=!1,i=l+1),f===46?o===-1?o=l:d!==1&&(d=1):o!==-1&&(d=-1)}return o===-1||i===-1||d===0||d===1&&o===i-1&&o===s+1?i!==-1&&(s===0&&n?t.base=t.name=e.slice(1,i):t.base=t.name=e.slice(s,i)):(s===0&&n?(t.name=e.slice(1,o),t.base=e.slice(1,i)):(t.name=e.slice(s,o),t.base=e.slice(s,i)),t.ext=e.slice(o,i)),s>0?t.dir=e.slice(0,s-1):n&&(t.dir="/"),t}function On(e){if(e=e instanceof URL?e:new URL(e),e.protocol!="file:")throw new TypeError("Must be a file URL.");return decodeURIComponent(e.pathname.replace(/%(?![0-9A-Fa-f]{2})/g,"%25"))}function Mn(e){if(!wt(e))throw new TypeError("Must be an absolute path.");let t=new URL("file:///");return t.pathname=be(e.replace(/%/g,"%25").replace(/\\/g,"%5C")),t}var Bn=ae?ce:le,{join:io,normalize:ao}=Bn;var $n=ae?ce:le;var{basename:uo,delimiter:fo,dirname:go,extname:ho,format:po,fromFileUrl:Ct,isAbsolute:mo,join:xo,normalize:Ro,parse:yo,relative:wo,resolve:At,sep:bo,toFileUrl:Co,toNamespacedPath:Ao}=$n;var Ae=Symbol("depth"),Te=Symbol("inHandler"),Wn=["..","..","function_chain.ts"],jn="runFunction",Tt=50,K=globalThis.Error,Ee=class e extends K{[Ae];[Te];constructor(t){K.stackTraceLimit=Tt,super(),this[Ae]=0,this[Te]=!1,K.prepareStackTrace=(n,r)=>{this[Ae]=r.length;for(let o of r)if(o.getFileName()===t&&o.getFunctionName()===jn){this[Te]=!0;break}},this.stack}static capture(){let t=K.prepareStackTrace,n=K.stackTraceLimit;try{let r=Ct(import.meta.url),o=At(r,...Wn),s=new e(o);return{capped:s[Ae]>=Tt,inHandler:s[Te]}}catch(r){return D.withError(r).error("Failed to set up stack tracer"),{capped:!1,inHandler:!1}}finally{K.prepareStackTrace=t,K.stackTraceLimit=n}}};var Ge=new Kn,Gn=()=>{let e=Ge.getStore();if(!e)return;let{chain:t,functionIndex:n}=e;return{chain:t,context:t.getContext(n),functionName:t.functionNames[n],requestID:t.requestID,spanID:t.spanID}},Et=new Set,F=e=>{let t=Gn();if(!t&&!Et.has(e)&&M()==="production"){let{capped:n,inHandler:r}=Ee.capture();(n||r)&&(Et.add(e),D.withFields({capped_stack_trace:n,type:e}).error("could not find execution context for request correlation"))}return t};var St=e=>!!e?.__netlifyStructuredLogger,G=(e,t,n)=>{let r=M(),{chain:o,functionName:s,requestID:i,spanID:a}=n??{};if(r==="production"){let l={edgeFunctionName:s,requestID:i,spanID:a};if(St(t[0])){let{fields:d,message:f,requestID:c}=t[0].serialize();c&&(l.requestID=c),l.type="systemJSON";let u={__nfmessage:f,...d};t=[JSON.stringify(u)]}if(o){let d=new URL(o.request.url);d.search.length>256&&(d.search="?query-params-truncated"),l.url=d.toString()}return e(JSON.stringify({__nfmeta:l}),...t)}if(St(t[0])){let l=t[0].serialize();if(!o?.request?.headers.has("x-nf-debug-logging"))return;t=[l.message,l.fields]}return s?e(`[${s}]`,...t):e(...t)},I=e=>(...t)=>{try{let n=F("logger");return G(e,t,{chain:n?.chain,functionName:n?.functionName,requestID:n?.requestID,spanID:n?.spanID})}catch{e(...t)}};var ue={error:globalThis.console.error,log:globalThis.console.log},Se={error:(e,...t)=>G(ue.error,t,e),log:(e,...t)=>G(ue.log,t,e)},D=dt.withRawLogger((...e)=>G(ue.log,e));function Lt(e){if(!e)return{};try{return JSON.parse(new TextDecoder().decode(Q(e)))}catch{return{}}}var Ve=Symbol("Netlify Logger"),b=Symbol("Netlify Internals");var zn=e=>{let t=Lt(e.get("x-nf-site-info")),n={context:e.get("x-nf-deploy-context")??void 0,id:e.get("x-nf-deploy-id")??void 0,published:e.get("x-nf-deploy-published")==="1"};return{account:st(e.get("x-nf-account-info")),blobs:it(e.get("x-nf-blobs-info")),bypassSettings:e.get("x-nf-edge-function-bypass"),cacheAPIURL:e.get("x-nf-pc-url"),cacheAPIToken:e.get("x-nf-pc-token"),cacheMode:e.get("x-nf-edge-function-cache"),cdnLoop:e.get("cdn-loop"),deploy:n,featureFlags:ve(e.get("x-nf-feature-flags")),forwardedHost:e.get("x-forwarded-host"),forwardedProtocol:e.get("x-forwarded-proto"),geo:ct(e.get("x-nf-geo")),ip:e.get("x-nf-client-connection-ip")??"",passthrough:e.get("x-nf-passthrough"),passthroughHost:e.get("x-nf-passthrough-host"),passthroughProtocol:e.get("x-nf-passthrough-proto"),requestID:e.get("x-nf-request-id"),spanID:e.get("x-nf-trace-span-id"),purgeAPIToken:e.get("x-nf-purge-api-token"),site:t}},W=class e extends Request{[b];[Ve];constructor(t,n){let r=t instanceof URL?new Request(t,n):t;super(r);let o=n instanceof e?n[b]:zn(this.headers);this[b]=o;let s=this.headers.get("x-nf-request-id"),i=this.headers.has("x-nf-debug-logging")?1:2;this[Ve]=D.withRequestID(s).withLogLevel(i),["x-nf-account-info","x-nf-pc-token","x-nf-pc-url","x-forwarded-host","x-forwarded-proto","x-nf-geo","x-nf-client-connection-ip","x-nf-edge-functions","x-deno-functions","x-nf-edge-functions-metadata","x-nf-passthrough","x-deno-pass","x-nf-passthrough-host","x-nf-passthrough-proto","x-nf-feature-flags","x-nf-edge-function-bypass","x-nf-site-info"].forEach(a=>{this.headers.delete(a)})}},Dt=e=>e[b].account,Pt=e=>e[b].blobs,Le=e=>e[b].cacheAPIURL,De=e=>e[b].cacheAPIToken,de=e=>e[b].cacheMode==="manual"?"manual":"off",ze=e=>e[b].deploy,vt=e=>e[b].geo,kt=e=>e[b].ip,ge=e=>e[Ve],Ft=e=>e[b].requestID??"",_t=e=>e[b].spanID??"",qt=e=>e[b].bypassSettings,It=e=>e[b].passthroughHeaders??new Headers,pt=e=>e[b].purgeAPIToken,Nt=(e,t)=>{e[b].passthroughHeaders=t[b].passthroughHeaders},Pe=e=>e[b].featureFlags,ie=e=>e[b].site,V=class extends Request{constructor({req:t,stripConditionalHeaders:n=!1,url:r=new URL(t.url)}){let o=t[b].passthrough,s=t[b].requestID;r.host=t[b].passthroughHost??r.host,r.protocol=t[b].passthroughProtocol??r.protocol;let i=t;t.body&&t.bodyUsed&&(console.warn("Request body already used. To use the body in further processing, pass the request to `context.next()`. See https://ntl.fyi/request-body-used for more information."),i=new Request(t,{body:""})),super(new Request(r.toString(),i)),o!==null&&this.headers.set("x-nf-passthrough",o),s!==null&&this.headers.set("x-nf-request-id",s),n&&lt.forEach(a=>{this.headers.delete(a)})}};var Je=(e,t)=>!!Pe(e)[t];function ve(e){if(!e)return{};try{let t=atob(e);return JSON.parse(t)}catch{return{}}}var Ut=e=>{let t=qt(e);return t?t==="1"?["passthrough"]:t.split(",").map(n=>n.trim()):[]},Qe=e=>Ut(e).includes("passthrough"),X=e=>Ut(e).includes("rewrite"),z=class extends Response{rewriteURL;constructor({cookies:t,currentRequest:n,initialRequestHeaders:r,initialRequestURL:o}){let s=new Headers({"x-nf-edge-function-bypass":"1"});if(!X(n)){super(null,{headers:s,status:204});return}let i={};n.url!==o.toString()&&(i.rewrite_url=n.url);let a=$e(r,n.headers);Object.keys(a).length!==0&&(i.request_headers=a);let l=ut(t.apply(new Headers));Object.keys(l).length!==0&&(i.response_headers=l);let[d,f]=Object.keys(i).length===0?[null,204]:[JSON.stringify(i),200];s.set("cache-control","no-transform"),super(d,{headers:s,status:f}),this.rewriteURL=i.rewrite_url}};function Ot(e){function t(d,f=2){return d.padStart(f,"0")}let n=t(e.getUTCDate().toString()),r=t(e.getUTCHours().toString()),o=t(e.getUTCMinutes().toString()),s=t(e.getUTCSeconds().toString()),i=e.getUTCFullYear(),a=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],l=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return`${a[e.getUTCDay()]}, ${n} ${l[e.getUTCMonth()]} ${i} ${r}:${o}:${s} GMT`}var Qn=/^(?=[\x20-\x7E]*$)[^()@<>,;:\\"\[\]?={}\s]+$/;function Yn(e){if(!e.name)return"";let t=[];if(Zn(e.name),er(e.name,e.value),t.push(`${e.name}=${e.value}`),e.name.startsWith("__Secure")&&(e.secure=!0),e.name.startsWith("__Host")&&(e.path="/",e.secure=!0,delete e.domain),e.secure&&t.push("Secure"),e.httpOnly&&t.push("HttpOnly"),typeof e.maxAge=="number"&&Number.isInteger(e.maxAge)&&(q(e.maxAge>=0,"Max-Age must be an integer superior or equal to 0"),t.push(`Max-Age=${e.maxAge}`)),e.domain&&(tr(e.domain),t.push(`Domain=${e.domain}`)),e.sameSite&&t.push(`SameSite=${e.sameSite}`),e.path&&(Xn(e.path),t.push(`Path=${e.path}`)),e.expires){let{expires:n}=e,r=Ot(typeof n=="number"?new Date(n):n);t.push(`Expires=${r}`)}return e.unparsed&&t.push(e.unparsed.join("; ")),t.join("; ")}function Zn(e){if(e&&!Qn.test(e))throw new TypeError(`Invalid cookie name: "${e}".`)}function Xn(e){if(e!=null)for(let t=0;t<e.length;t++){let n=e.charAt(t);if(n<" "||n>"~"||n==";")throw new Error(e+": Invalid cookie path char '"+n+"'")}}function er(e,t){if(!(t==null||e==null))for(let n=0;n<t.length;n++){let r=t.charAt(n);if(r<"!"||r=='"'||r==","||r==";"||r=="\\"||r=="\x7F")throw new Error("RFC2616 cookie '"+e+"' cannot contain character '"+r+"'");if(r>"\x80")throw new Error("RFC2616 cookie '"+e+"' can only have US-ASCII chars as value"+r.charCodeAt(0).toString(16))}}function tr(e){if(e==null)return;let t=e.charAt(0),n=e.charAt(e.length-1);if(t=="-"||n=="."||n=="-")throw new Error("Invalid first/last char in cookie domain: "+e)}function Mt(e){let t=e.get("Cookie");if(t!=null){let n={},r=t.split(";");for(let o of r){let[s,...i]=o.split("=");q(s!=null);let a=s.trim();n[a]=i.join("=")}return n}return{}}function ke(e,t){let n=Yn(t);n&&e.append("Set-Cookie",n)}function Ht(e,t,n){ke(e,{name:t,value:"",expires:new Date(0),...n})}var Fe=class{ops;request;constructor(t){this.ops=[],this.request=t}apply(t){return this.ops.forEach(n=>{switch(n.type){case"delete":Ht(t,n.options.name,{domain:n.options.domain,path:n.options.path});break;case"set":ke(t,n.cookie);break}}),t}delete(t){let n={path:"/"},r=typeof t=="string"?{name:t}:t;this.ops.push({options:{...n,...r},type:"delete"})}get(t){let n=typeof t=="string"?t:t.name;return Mt(this.request.headers)[n]}getPublicInterface(){return{delete:this.delete.bind(this),get:this.get.bind(this),set:this.set.bind(this)}}set(t,n){let r;if(typeof t=="string"){if(typeof n!="string")throw new Error("You must provide the cookie value as a string to 'cookies.set'");r={name:t,value:n}}else r=t;this.validate(r),this.ops.push({cookie:r,type:"set"})}validate(t){ke(new Headers,t)}};var nr={efcar:100,efcaw:20},ee=class e{counts;limits;fetchCalls;invokedFunctions;passthroughCalls;id;constructor(t,n=nr){this.id=Math.random(),this.counts=t?.counts??new Map,this.limits=n,this.fetchCalls=t?.fetchCalls??[],this.invokedFunctions=t?.invokedFunctions??[],this.passthroughCalls=t?.passthroughCalls??[]}static formatDuration(t){let n=t.toFixed(1);return n.endsWith(".0")?n.split(".")[0]:n}trackFetchCall(t){let n={host:t,start:performance.now()},r=()=>{n.end=performance.now()};return this.fetchCalls.push(n),{end:r}}getFetchTiming(){let t=[];for(let n of this.fetchCalls){let r=n.host?`host=${n.host}`:"passthrough",o=(n.end??performance.now())-n.start;t.push(`${r};dur=${e.formatDuration(o)}`)}return t}registerOperation(t){let n=this.counts.get(t)||0,r=this.limits[t]||0;return this.counts.set(t,n+1),r-n}registerInvokedFunction(t){this.invokedFunctions.push(t)}startFetch(t){return this.trackFetchCall(t)}startPassthrough(){return this.trackFetchCall()}writeHeaders(t){t.set("x-nf-edge-functions",this.invokedFunctions.join(","));for(let r of this.getFetchTiming())t.append("x-nf-fetch-timing",r);let n=["efcar","efcaw"].map(r=>`${r};count=${this.counts.get(r)??0}`);t.set("x-nf-invocation-metrics",n.join(","))}};var Bt=(e,t)=>{if(e===void 0)return{};let r=new URLPattern({pathname:e}).exec(t)?.pathname.groups;return r?Object.entries(r).reduce((s,[i,a])=>a===void 0?s:{...s,[i]:a},{}):{}};function Wt(e,t={}){let{signal:n,persistent:r}=t;return n?.aborted?Promise.reject(new DOMException("Delay was aborted.","AbortError")):new Promise((o,s)=>{let i=()=>{clearTimeout(l),s(new DOMException("Delay was aborted.","AbortError"))},l=setTimeout(()=>{n?.removeEventListener("abort",i),o()},e);if(n?.addEventListener("abort",i,{once:!0}),r===!1)try{Deno.unrefTimer(l)}catch(d){if(!(d instanceof ReferenceError))throw d;console.error("`persistent` option is only available in Deno")}})}var k=class extends Error{},J=class extends Error{constructor(t){super("An unretriable error has occurred",{cause:t})}},te=class extends Error{constructor(t){let n=t instanceof J?t.cause:t;super("There was an internal error while processing your request",{cause:n})}};var rr=5,jt=1e3,or=3;async function Kt(e,{maxRetries:t=or}={}){let n,r=0,o=new Error;for(;r<t;)try{return await e(r)}catch(s){if(o=s,s instanceof J)break;r+=1,n===void 0?n=rr:n*=2,n>jt&&(n=jt),await Wt(n)}throw o}var sr=new Set(["x-nf-ats-version","x-nf-cache-result","x-bb-cache","x-bb-site-cancelled","x-bb-proxy-type","x-nf-function-type","x-nf-func-id","x-nf-block-reason","x-nf-passthrough-timing"]),_e=class extends Response{[b]={passthroughHeaders:new Headers};constructor(t){super(t.body,t),this.headers.forEach((n,r)=>{sr.has(r)&&(this[b].passthroughHeaders.set(r,n),this.headers.delete(r))}),this.headers.delete("via")}};var qe=class{functions;requestRoutes;routes;constructor(t,n){let r=n.function_config??{},o=new Map;Array.isArray(n.req_routes)&&(this.requestRoutes=n.req_routes),Object.entries(t).forEach(([s,i])=>{if(i===void 0)return;let a={excludedPatterns:[],onError:"fail"},{excluded_patterns:l,generator:d,on_error:f}=r[s]??{};if(l){let c=l.map(u=>new RegExp(u));a.excludedPatterns.push(...c)}f&&(f==="bypass"||f==="fail"||typeof f=="string"&&f.startsWith("/"))&&(a.onError=f),d&&(a.generator=d),o.set(s,{config:a,source:i})}),this.functions=o,this.routes=(n.routes??[]).map(s=>{let i=o.get(s.function);return i===void 0?null:{config:i.config,name:s.function,path:s.path,pattern:new RegExp(s.pattern),source:i.source,methods:s.methods??[]}})}getFunction(t){return this.functions.get(t)}getRequestRoute(t){if(!this.requestRoutes)return null;let n=this.requestRoutes[t];return this.routes[n]}match(t,n){return this.routes.map(o=>{if(o===null||!o.pattern.test(t.pathname)||o.methods.length>0&&!o.methods.includes(n))return;let i=this.functions.get(o.name);if(i===void 0||i.config.excludedPatterns.some(u=>u.test(t.pathname)))return;let{config:l,name:d,path:f,source:c}=o;return{config:l,name:d,path:f,source:c}}).filter(Boolean)}};var ir=new Set([301,302,303,307,308]),Gt=e=>{let t=[...e.headers.keys()];return e.body===null&&ir.has(e.status)&&t.length===1&&t[0]==="location"},Vt=e=>(...t)=>{let[n,r]=t;if(typeof n=="string"&&n.startsWith("/"))try{let o=F("response-redirect");if(o?.chain===void 0)throw new Error("Could not find chain");let{chain:s}=o,i=new URL(n,s.request.url);return e(i,r)}catch(o){D.withError(o).log("An error occurred in the patched Response.redirect")}return e(...t)};var ar=Deno.env.get("DENO_REGION")??"",cr=Deno.env.get("DENO_RUNNER_IP")??"",Ie=class e{cacheMode;cookies;contextNextCalls;executionController;functionNames;initialHeaders;initialRequestURL;loggedMessages;metrics;rawLogger;request;router;timeoutSignal;constructor({request:t,cookies:n=new Fe(t),executionController:r,functionNames:o,initialMetrics:s,initialRequestURL:i=new URL(t.url),loggedMessages:a,rawLogger:l,router:d,timeoutSignal:f},c){this.cacheMode=de(t),this.cookies=n,this.contextNextCalls=[],this.executionController=r??new AbortController,this.functionNames=o,this.initialHeaders=new Headers(t.headers),this.initialRequestURL=i,this.loggedMessages=a??new Set,this.metrics=new ee(s??c?.metrics),this.rawLogger=l,this.request=t,this.router=d,this.timeoutSignal=f??c?.timeoutSignal}async fetchPassthrough(t){try{return await this.fetchPassthroughWithRetries(t)}catch(n){throw new te(n)}}async fetchPassthroughWithRetries(t){let n=performance.now(),r=this.contextNextCalls.length>0&&this.contextNextCalls.some(a=>!a.sendConditionalRequest),o=new V({req:this.request,stripConditionalHeaders:r,url:t}),s=await Kt(async a=>{let l=this.logger.withFields({context_next_count:this.contextNextCalls.length,method:o.method,origin_url:o.url,retry_count:a,strip_conditional_headers:r,deno_runner_public_ip:cr});l.debug(a===0?"Started edge function request to origin":"Retrying edge function request to origin");let d=AbortSignal.any([o.signal,this.executionController.signal]),f=this.metrics.startPassthrough();try{return await fetch(o,{redirect:"manual",signal:d})}catch(c){if(c.name==="TypeError"&&(c.message==="Failed to fetch: request body stream errored"||c.message.includes("http2 error: stream error sent by user"))||o.signal.aborted)return new Response(null,{status:499});throw l.withFields({body_used:o.bodyUsed,error:c.message}).log("Error in passthrough call"),!o.bodyUsed&&c.name!=="AbortError"?c:new J(c)}finally{f.end()}}),i=new _e(s);return Nt(this.request,i),this.logger.withFields({origin_duration:performance.now()-n,origin_status:s.status,origin_url:t}).withRequestID(this.requestID).debug("Finished edge function request to origin"),i}contextNext(t,n,r={}){if(n&&new URL(n.url).origin!==new URL(this.request.url).origin)throw new k("Edge functions can only rewrite requests to the same host. For more information, visit https://ntl.fyi/edge-rewrite-external");return this.contextNextCalls.push(r),n&&(this.request=new W(n,this.request)),this.runFunction({functionIndex:t+1,nextOptions:r,requireFinalResponse:!0})}getContext(t){let n=this.router.getRequestRoute(t),r=this.request.url;return{cookies:this.cookies.getPublicInterface(),deploy:ze(this.request),geo:vt(this.request),ip:kt(this.request),json:this.json.bind(this),log:this.getLogFunction(t),next:(s,i={})=>(this.logger.withFields({functionIndex:t,functionName:this.functionNames[t]}).debug("Function called `context.next()`"),s instanceof Request?this.contextNext(t,s,i):this.contextNext(t,void 0,s)),get params(){return Bt(n?.path,r)},requestId:this.requestID,spanID:this.spanID,rewrite:this.rewrite.bind(this),site:ie(this.request),account:Dt(this.request),server:{region:ar},url:new URL(r)}}getFunction(t){let n=this.functionNames[t];if(n===void 0)return;let r=this.router.getFunction(n);if(r===void 0)throw new Error(`Could not find function '${n}'`);let{config:o,source:s}=r;return{config:o,name:n,source:s}}getLogFunction(t){let n=this.functionNames[t],r=this.rawLogger??console.log;return(...o)=>G(r,o,{chain:this,functionName:n,requestID:this.requestID,spanID:this.spanID})}get logger(){return ge(this.request)}get throttledLogger(){return ge(this.request).withFilter(t=>this.loggedMessages.has(t)?!1:(this.loggedMessages.add(t),!0))}json(t,n){let r=JSON.stringify(t),o=new Response(r,n);return o.headers.set("content-type","application/json"),o}makeURL(t){return t.startsWith("/")?new URL(t,this.request.url):new URL(t)}get requestID(){return Ft(this.request)}get spanID(){return _t(this.request)}rewrite(t){let n=t instanceof URL?t:this.makeURL(t);if(n.origin!==this.initialRequestURL.origin)throw new k("Edge functions can only rewrite requests to the same host. For more information, visit https://ntl.fyi/edge-rewrite-external");return this.logger.withFields({url:n.href}).debug("Calling origin as part of a `context.rewrite()` call"),this.fetchPassthrough(n)}async run({previousRewrites:t,requireFinalResponse:n}={}){let r=Pt(this.request),o=ze(this.request),s=ie(this.request);at(r,o,s);let i=await this.runFunction({functionIndex:0,previousRewrites:t,requireFinalResponse:n});return i instanceof z||(Gt(i)&&(i=new Response(null,i)),this.cookies.apply(i.headers)),i}runWithSignal(t){let n=!1,r=this.timeoutSignal;return r?(r.addEventListener("abort",()=>{n||this.executionController.abort()}),new Promise((o,s)=>{this.executionController.signal.addEventListener("abort",()=>{s(this.executionController.signal.reason)}),this.run(t).then(o).catch(s).finally(()=>{n=!0})})):this.run(t)}async runFunction({functionIndex:t,nextOptions:n,previousRewrites:r=new Set,requireFinalResponse:o=!1}){let s=this.getFunction(t),i=this.logger.withFields({functionIndex:t,functionName:s?.name,url:this.request.url});if(s===void 0)return Qe(this.request)&&!o&&this.request.body===null&&de(this.request)==="off"&&(!We(this.initialHeaders,this.request.headers)||X(this.request))?(i.debug("Returning bypass response"),new z({cookies:this.cookies,currentRequest:this.request,initialRequestHeaders:this.initialHeaders,initialRequestURL:this.initialRequestURL})):(i.withFields({supportsPassthroughBypass:Qe(this.request),requireFinalResponse:o,hasBody:this.request.body!==null,mutatedHeaders:We(this.initialHeaders,this.request.headers),supportsRewriteBypass:X(this.request)}).debug("Calling origin at the end of function chain"),this.fetchPassthrough());let{config:a,name:l,source:d}=s,f=this.getContext(t);this.metrics.registerInvokedFunction(l);try{let c=await Ge.run({chain:this,functionIndex:t},()=>d(this.request,f));if(c instanceof URL){if(i.debug("Function returned a URL object"),c.origin!==this.initialRequestURL.origin)throw new k(`Rewrite to '${c.toString()}' is not allowed: edge functions can only rewrite requests to the same base URL`);let u=X(this.request)&&this.request.body===null;if(r.has(c.pathname))throw new k(`Loop detected: the path '${c.pathname}' has been both the source and the target of a rewrite in the same request`);let R=new W(c,this.request),w=this.router.match(c,R.method);if(w.length===0)return u&&!o?new z({cookies:this.cookies,currentRequest:R,initialRequestHeaders:this.initialHeaders,initialRequestURL:this.initialRequestURL}):(i.withFields({canBypass:u,requireFinalResponse:o}).debug("Calling origin as a result of a rewrite with a URL object"),this.fetchPassthrough(c));let j=new e({cookies:this.cookies,executionController:this.executionController,functionNames:w.map(g=>g.name),initialRequestURL:this.initialRequestURL,rawLogger:this.rawLogger,request:R,router:this.router,timeoutSignal:this.timeoutSignal},this),B={previousRewrites:new Set([...r,c.pathname]),requireFinalResponse:o||!u};return this.timeoutSignal?j.runWithSignal(B):j.run(B)}if(c===void 0)return i.debug("Function returned undefined"),this.runFunction({functionIndex:t+1,nextOptions:n,requireFinalResponse:o});if(c instanceof Response)return i.debug("Function returned a response"),xe(c,u=>{u.delete("content-length")});throw new k(`Function '${l}' returned an unsupported value. Accepted types are 'Response', 'URL' or 'undefined'`)}catch(c){let u={chain:this,functionName:l,requestID:this.requestID,spanID:this.spanID};if(i.withFields({onError:a.onError}).debug("Function has thrown an error"),a.onError==="fail")throw Se.error(u,c),c;if(a.onError==="bypass")return Se.error(u,c),this.runFunction({functionIndex:t+1,nextOptions:n,requireFinalResponse:o});if(o)throw c;Se.error(u,c);let C=new URL(a.onError,this.request.url);return X(this.request)?new z({cookies:this.cookies,currentRequest:new W(C,this.request),initialRequestHeaders:this.initialHeaders,initialRequestURL:this.initialRequestURL}):(this.logger.debug("Calling origin as part of a rewrite failure mode"),this.fetchPassthrough(C))}}};var lr={delete:Deno.env.delete,get:Deno.env.get,has:Deno.env.has,set:Deno.env.set,toObject:Deno.env.toObject},zt={get context(){return F("netlify-global")?.context??null},env:lr};function Jt(e){if(!e)return{};try{return JSON.parse(atob(e))}catch{throw new Error("Could not parse edge functions invocation metadata")}}globalThis.Netlify=zt;globalThis.addEventListener("unhandledrejection",e=>{if(e.reason instanceof DOMException&&e.reason.name==="AbortError"){D.withError(e.reason).debug("found unhandled AbortError exception"),e.preventDefault();return}});var Ye=async(e,t,{fetchRewrites:n,rawLogger:r=console.log,requestTimeout:o=0}={})=>{let s=e.headers.get("x-nf-request-id"),i=M(),a=D.withRequestID(s),l=ve(e.headers.get("x-nf-feature-flags")),d=new ee,f=l.edge_functions_bootstrap_invocation_timeout&&o?AbortSignal.timeout(o):void 0;try{let c=e.headers.get("x-nf-edge-functions"),u=Jt(e.headers.get("x-nf-edge-functions-metadata")),C=new qe(t,u);if(s==null||c==null)return new Response("Request must have headers for request ID and functions names",{status:400,headers:{"content-type":"text/plain"}});let R=new URL(e.url);if(l.edge_functions_bootstrap_decode_query)try{R.search=decodeURIComponent(R.search)}catch{a.withFields({query:R.search}).log("Failed to decode query")}if(M()==="local"&&(R.protocol=e.headers.get("x-forwarded-proto")??R.protocol,R.host=e.headers.get("x-forwarded-host")??R.host,e.headers.has("x-nf-passthrough-host")&&e.headers.has("x-nf-passthrough-proto"))){let E=`${e.headers.get("x-nf-passthrough-proto")}//${e.headers.get("x-nf-passthrough-host")}`;E!==R.origin&&n?.set(R.origin,E)}let w=new W(new Request(R,e)),j=De(w),B=Le(w),g=[...new Set(c.split(","))],h=new Ie({functionNames:g,initialMetrics:d,rawLogger:r,request:w,router:C,timeoutSignal:f}),p=ge(w).withFields({cache_mode:de(w),feature_flags:Object.keys(Pe(w)),function_names:g,url:e.url});ht(w),p.withFields({cache_api_token:!!j,cache_api_url:!!B}).debug("Started processing edge function request");let y=performance.now(),x=await(f?h.runWithSignal():h.run());It(w).forEach((E,pe)=>{x.headers.has(pe)&&p.withFields({header:pe}).log("user-defined header overwritten by passthrough header"),x.headers.set(pe,E)});let T=performance.now();return p.withFields({ef_duration:T-y}).debug("Finished processing edge function request"),xe(x,E=>{d.writeHeaders(E)})}catch(c){let u=String(c);if(i==="local")c instanceof Error?u=JSON.stringify({error:{name:c.name,message:c.message,stack:c.stack,cause:String(c.cause)}}):u=JSON.stringify({error:String(c)});else if(i==="production"){let R={fetch_timing:d.getFetchTiming().join(","),req_aborted:e.signal.aborted.toString()};if(c instanceof Error){let w=c instanceof k?"error_user":"error_unknown";R.error_name=c.name,R.error_message=c.message,R.error_stack=c.stack,R.error_cause=String(c.cause),R.error_type=w}else R.error_message=String(c);a.withFields(R).log("uncaught exception while handling request")}let C=new Response(u,{status:500,headers:{"x-nf-uncaught-error":fr(c)}});return d.writeHeaders(C.headers),C}},fr=e=>e instanceof te?"passthrough":e instanceof Error&&(e?.name==="AbortError"||e?.name==="TimeoutError")?"timeout":"1";var{hasOwn:Yt}=Object;function A(e,t){if(Yt(e,t))return e[t]}function Ze(e,t){let n=A(e,t);return q(n!=null),n}function Qt(e){return typeof e=="number"||/^0x[0-9a-f]+$/i.test(String(e))?!0:/^[-+]?(?:\d+(?:\.\d*)?|\.\d+)(e[-+]?\d+)?$/.test(String(e))}function Xe(e,t){let n=e;t.slice(0,-1).forEach(o=>{n=A(n,o)??{}});let r=t[t.length-1];return Yt(n,r)}function Zt(e,{"--":t=!1,alias:n={},boolean:r=!1,default:o={},stopEarly:s=!1,string:i=[],collect:a=[],negatable:l=[],unknown:d=f=>f}={}){let f={},c={bools:{},strings:{},unknownFn:d,allBools:!1,collect:{},negatable:{}};if(n!==void 0)for(let g in n){let h=Ze(n,g);typeof h=="string"?f[g]=[h]:f[g]=h;for(let p of Ze(f,g))f[p]=[g].concat(f[g].filter(y=>p!==y))}if(r!==void 0)if(typeof r=="boolean")c.allBools=!!r;else{let g=typeof r=="string"?[r]:r;for(let h of g.filter(Boolean)){c.bools[h]=!0;let p=A(f,h);if(p)for(let y of p)c.bools[y]=!0}}if(i!==void 0){let g=typeof i=="string"?[i]:i;for(let h of g.filter(Boolean)){c.strings[h]=!0;let p=A(f,h);if(p)for(let y of p)c.strings[y]=!0}}if(a!==void 0){let g=typeof a=="string"?[a]:a;for(let h of g.filter(Boolean)){c.collect[h]=!0;let p=A(f,h);if(p)for(let y of p)c.collect[y]=!0}}if(l!==void 0){let g=typeof l=="string"?[l]:l;for(let h of g.filter(Boolean)){c.negatable[h]=!0;let p=A(f,h);if(p)for(let y of p)c.negatable[y]=!0}}let u={_:[]};function C(g,h){return c.allBools&&/^--[^=]+$/.test(h)||A(c.bools,g)||!!A(c.strings,g)||!!A(f,g)}function R(g,h,p,y=!0){let x=g,T=h.split(".");T.slice(0,-1).forEach(function(Be){A(x,Be)===void 0&&(x[Be]={}),x=A(x,Be)});let E=T[T.length-1];y&&!!A(c.collect,h)?A(x,E)===void 0?x[E]=[p]:Array.isArray(A(x,E))?x[E].push(p):x[E]=[A(x,E),p]:x[E]=p}function w(g,h,p=void 0,y){if(p&&c.unknownFn&&!C(g,p)&&c.unknownFn(p,g,h)===!1)return;let x=!A(c.strings,g)&&Qt(h)?Number(h):h;R(u,g,x,y);let T=A(f,g);if(T)for(let E of T)R(u,E,x,y)}function j(g){return Ze(f,g).some(h=>typeof A(c.bools,h)=="boolean")}let B=[];e.includes("--")&&(B=e.slice(e.indexOf("--")+1),e=e.slice(0,e.indexOf("--")));for(let g=0;g<e.length;g++){let h=e[g];if(/^--.+=/.test(h)){let p=h.match(/^--([^=]+)=(.*)$/s);q(p!=null);let[,y,x]=p;c.bools[y]?w(y,x!=="false",h):w(y,x,h)}else if(/^--no-.+/.test(h)&&A(c.negatable,h.replace(/^--no-/,""))){let p=h.match(/^--no-(.+)/);q(p!=null),w(p[1],!1,h,!1)}else if(/^--.+/.test(h)){let p=h.match(/^--(.+)/);q(p!=null);let[,y]=p,x=e[g+1];x!==void 0&&!/^-/.test(x)&&!A(c.bools,y)&&!c.allBools&&(!A(f,y)||!j(y))?(w(y,x,h),g++):/^(true|false)$/.test(x)?(w(y,x==="true",h),g++):w(y,A(c.strings,y)?"":!0,h)}else if(/^-[^-]+/.test(h)){let p=h.slice(1,-1).split(""),y=!1;for(let T=0;T<p.length;T++){let E=h.slice(T+2);if(E==="-"){w(p[T],E,h);continue}if(/[A-Za-z]/.test(p[T])&&/=/.test(E)){w(p[T],E.split(/=(.+)/)[1],h),y=!0;break}if(/[A-Za-z]/.test(p[T])&&/-?\d+(\.\d*)?(e-?\d+)?$/.test(E)){w(p[T],E,h),y=!0;break}if(p[T+1]&&p[T+1].match(/\W/)){w(p[T],h.slice(T+2),h),y=!0;break}else w(p[T],A(c.strings,p[T])?"":!0,h)}let[x]=h.slice(-1);!y&&x!=="-"&&(e[g+1]&&!/^(-|--)[^-]/.test(e[g+1])&&!A(c.bools,x)&&(!A(f,x)||!j(x))?(w(x,e[g+1],h),g++):e[g+1]&&/^(true|false)$/.test(e[g+1])?(w(x,e[g+1]==="true",h),g++):w(x,A(c.strings,x)?"":!0,h))}else if((!c.unknownFn||c.unknownFn(h)!==!1)&&u._.push(c.strings._??!Qt(h)?h:Number(h)),s){u._.push(...e.slice(g+1));break}}for(let[g,h]of Object.entries(o))if(!Xe(u,g.split("."))&&(R(u,g,h),f[g]))for(let p of f[g])R(u,p,h);for(let g of Object.keys(c.bools))if(!Xe(u,g.split("."))){let h=A(c.collect,g)?[]:!1;R(u,g,h,!1)}for(let g of Object.keys(c.strings))!Xe(u,g.split("."))&&A(c.collect,g)&&R(u,g,[],!1);if(t){u["--"]=[];for(let g of B)u["--"].push(g)}else for(let g of B)u._.push(g);return u}var dr=e=>e instanceof URL?e:new URL(typeof e=="string"?e:e.url),gr=e=>{try{return dr(e)}catch{}},Xt=e=>async(...t)=>{if(t[0]instanceof V)return e(...t);let n=gr(t[0]);if(n===void 0)return D.withFields({args:t}).error("Could not get URL from arguments in fetch call"),e(...t);let r=F("track-subrequests");if(r?.chain===void 0)return e(...t);let{chain:o}=r,{signal:s}=t[1]??{},{signal:i}=o.executionController,a=AbortSignal.any([s,i].filter(Boolean));t[1]={...t[1],signal:a};let l=o.metrics.startFetch(n.host);try{return await e(...t)}finally{l.end()}},en=(e,t)=>(n,r)=>{let o;if(n instanceof URL)o=n;else if(typeof n=="string")o=new URL(n);else if(n instanceof Request)o=new URL(n.url);else return e(n,r);let s=t.get(o.origin);if(s===void 0)return e(n,r);let i=new URL(o.pathname+o.search+o.hash,s);if(n instanceof Request){let a=new Request(i,n);return e(a,r)}return e(i,r)},tn=e=>(t,n)=>{if(t instanceof V)return e(t,n);let r=F("forward-headers");if(r?.chain===void 0)return e(t,n);let{chain:o}=r,s=new Request(t,n),{cdnLoop:i,requestID:a}=o.request[b];return a&&Je(o.request,"edge_functions_bootstrap_forward_request_id")&&s.headers.set("x-nf-request-id",a),i&&Je(o.request,"edge_functions_bootstrap_forward_cdn_loop")&&s.headers.append("cdn-loop",i),e(s)};var on=(e,t,n)=>{if(!t.has(e))throw TypeError("Cannot "+n)},P=(e,t,n)=>(on(e,t,"read from private field"),n?n.call(e):t.get(e)),re=(e,t,n)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,n)},oe=(e,t,n,r)=>(on(e,t,"write to private field"),r?r.call(e,n):t.set(e,n),n),He=(e=>(e.Delete="delete",e.Read="read",e.Write="write",e))(He||{}),hr={invalid_vary:"Responses must not use unsupported directives of the `Netlify-Vary` header (https://ntl.fyi/cache_api_invalid_vary).",no_cache:"Responses must not set cache control headers with the `private`, `no-cache` or `no-store` directives (https://ntl.fyi/cache_api_no_cache).",low_ttl:"Responses must have a cache control header with a `max-age` or `s-maxage` directive (https://ntl.fyi/cache_api_low_ttl).",no_directive:"Responses must have a cache control header with caching directives (https://ntl.fyi/cache_api_no_directive).",no_ttl:"Responses must have a cache control header with a `max-age` or `s-maxage` directive (https://ntl.fyi/cache_api_no_ttl).",no_status:"Responses must specify a status code (https://ntl.fyi/cache_api_no_status).",invalid_directive:"Responses must have a cache control header with caching directives (https://ntl.fyi/cache_api_invalid_directive).",status:"Responses must have a status code between 200 and 299 (https://ntl.fyi/cache_api_status)."},pr="The server has returned an unexpected error (https://ntl.fyi/cache_api_error).",mr="netlify-programmable-error",xr="netlify-programmable-headers",Rr="netlify-programmable-status",yr="netlify-programmable-store",wr="netlify-forwarded-host",br="user-agent",nn=new Set(["http:","https:"]),Cr=new Set(["cookie","content-encoding","content-length"]),Ne=Symbol("getInternalHeaders"),rn=Symbol("serializeResourceHeaders"),Ue,ne,Oe,he,Ar=class{constructor({base64Encode:e,getContext:t,name:n,userAgent:r}){re(this,Ue,void 0),re(this,ne,void 0),re(this,Oe,void 0),re(this,he,void 0),oe(this,Ue,e),oe(this,ne,t),oe(this,Oe,n),oe(this,he,r)}[Ne](e){let{host:t,token:n}=e,r={Authorization:`Bearer ${n}`,[yr]:P(this,Oe)};return t&&(r[wr]=t),P(this,he)&&(r[br]=P(this,he)),r}[rn](e){let t={};return e.forEach((n,r)=>{Cr.has(r)||(r==="set-cookie"?(t[r]=t[r]||[],t[r].push(n)):t[r]=n.split(","))}),P(this,Ue).call(this,JSON.stringify(t))}async add(e){await this.put(new Request(e),await fetch(e))}async addAll(e){await Promise.allSettled(e.map(t=>this.add(t)))}async delete(e){let t=P(this,ne).call(this,{operation:"delete"});if(t){let n=et(e);await fetch(`${t.url}/${tt(n)}`,{headers:this[Ne](t),method:"DELETE"})}return!0}async keys(e){return[]}async match(e){try{let t=P(this,ne).call(this,{operation:"read"});if(!t)return;let n=et(e),r=`${t.url}/${tt(n)}`,o=await fetch(r,{headers:this[Ne](t),method:"GET"});return o.ok?o:void 0}catch{}}async matchAll(e,t){if(!e)return[];let n=await this.match(e);return n?[n]:[]}async put(e,t){if(!t.ok)throw new TypeError(`Cannot cache response with status ${t.status}.`);if(e instanceof Request&&e.method!=="GET")throw new TypeError(`Cannot cache response to ${e.method} request.`);if(t.status===206)throw new TypeError("Cannot cache response to a range request (206 Partial Content).");if(t.headers.get("vary")?.includes("*"))throw new TypeError("Cannot cache response with 'Vary: *' header.");let n=P(this,ne).call(this,{operation:"write"});if(!n)return;let r=et(e),o=await fetch(`${n.url}/${tt(r)}`,{body:t.body,headers:{...this[Ne](n),[xr]:this[rn](t.headers),[Rr]:t.status.toString()},duplex:"half",method:"POST"});if(!o.ok){let s=o.headers.get(mr)??"",i=hr[s]||pr;n.logger?.(`Failed to write to the cache: ${i}`)}}};Ue=new WeakMap;ne=new WeakMap;Oe=new WeakMap;he=new WeakMap;var et=e=>{let t;if(e instanceof Request)t=new URL(e.url);else try{t=new URL(String(e))}catch{throw new TypeError(`${e} is not a valid URL.`)}if(!nn.has(t.protocol))throw new TypeError(`Cannot cache response for URL with unsupported protocol (${t.protocol}). Supported protocols are ${[...nn].join(", ")}.`);return t},tt=e=>encodeURIComponent(e.toString()),Me,N,sn=class{constructor(e){re(this,Me,void 0),re(this,N,void 0),oe(this,Me,e),oe(this,N,new Map)}open(e){let t=P(this,N).get(e);return t||(t=new Ar({...P(this,Me),name:e}),P(this,N).set(e,t)),Promise.resolve(t)}has(e){return Promise.resolve(P(this,N).has(e))}delete(e){return Promise.resolve(P(this,N).delete(e))}keys(){return Promise.resolve([...P(this,N).keys()])}async match(e,t){if(t?.cacheName)return P(this,N).get(t.cacheName)?.match(e);for(let n of P(this,N).values())if(await n.match(e)===void 0)return}};Me=new WeakMap;N=new WeakMap;var Tr="1.7.1";var an=()=>new sn({base64Encode:me,getContext:({operation:e})=>{let n=F("cache-api")?.chain;if(!n?.request)throw new k("The Cache API must be used within the scope of the request handler. Refer to https://ntl.fyi/cache-api-scope for more information.");let r=e===He.Delete||e===He.Write?"efcaw":"efcar",o=n.metrics.registerOperation(r);if(o<=0)return o===0&&ue.log(`You've exceeded the number of allowed Cache API ${r==="efcaw"?"writes":"reads"} for a single invocation. Refer to https://ntl.fyi/cache-api-limits for more information.`),null;let{request:s}=n,i=new URL(s.url).hostname,a=De(s),l=Le(s);if(!a||!l)return D.withFields({has_token:!!a,has_url:!!l}).log("missing Cache API metadata in request"),null;let d=new URL("/.netlify/cache",l);return{logger:f=>n.throttledLogger.log(f),host:i,url:d.toString(),token:a}},userAgent:`netlify-edge-functions@${Tr}`});var Er=()=>{throw new k("Reading or writing files with Edge Functions is not supported yet. Visit https://ntl.fyi/edge-functions-filesystem to learn more and tell us about your use cases for file system access.")};function U(e){return Er}var nt=" ",Sr=(e,t,n)=>{let r=I((...i)=>e(i.join(nt))),o=I((i,a,...l)=>t([i,a].join(nt),...l)),s=I((...i)=>n(i.join(nt)));return{time:r,timeLog:o,timeEnd:s}},rt=()=>{globalThis.console.log=I(globalThis.console.log),globalThis.console.error=I(globalThis.console.error),globalThis.console.debug=I(globalThis.console.debug),globalThis.console.warn=I(globalThis.console.warn),globalThis.console.info=I(globalThis.console.info),globalThis.console.trace=I(globalThis.console.trace);let{time:e,timeLog:t,timeEnd:n}=Sr(globalThis.console.time,globalThis.console.timeLog,globalThis.console.timeEnd);globalThis.console.time=e,globalThis.console.timeLog=t,globalThis.console.timeEnd=n,globalThis.Deno.cwd=U(globalThis.Deno.cwd),globalThis.Deno.readDir=U(globalThis.Deno.readDir),globalThis.Deno.readFile=U(globalThis.Deno.readFile),globalThis.Deno.readTextFile=U(globalThis.Deno.readTextFile),globalThis.Deno.open=U(globalThis.Deno.open),globalThis.Deno.stat=U(globalThis.Deno.stat),globalThis.Deno.lstat=U(globalThis.Deno.lstat),globalThis.Deno.realPath=U(globalThis.Deno.realPath),globalThis.Deno.readLink=U(globalThis.Deno.readLink),Response.redirect=Vt(Response.redirect),globalThis.fetch=tn(globalThis.fetch),globalThis.fetch=Xt(globalThis.fetch),Lr()},Lr=()=>{globalThis.caches&&delete globalThis.caches,globalThis.caches=an()};var Dr=37e3,Pr=Dr-1e3,vr=globalThis.console.log,cn=new Map;M()==="local"&&(globalThis.fetch=en(globalThis.fetch,cn));rt();var kr=e=>{let t={onListen(){}},{port:n}=Zt(Deno.args);return n&&(t.port=n),Deno.serve(t,o=>Ye(o,e,{fetchRewrites:cn,rawLogger:vr,requestTimeout:Pr})).finished};export{kr as boot,Ye as handleRequest,rt as patchGlobals};
